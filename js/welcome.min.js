function initializeCard(){const targetLat=23.106469,targetLng=113.32446,visitorInfoAPI="https://api.vvhan.com/api/visitor.info",ipLocationAPI="https://api.76.al/api/ipip/query?key=SJd0EOHBOxCiP786zH2E4sE0S6&ip=",cacheExpirationTime=36e5;function haversineDistance(lat1,lon1,lat2,lon2){const R=6371,dLat=(lat2-lat1)*(Math.PI/180),dLon=(lon2-lon1)*(Math.PI/180),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),distance=R*c;return distance}function handleGeolocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(position=>{const lat=position.coords.latitude,lng=position.coords.longitude;fetchAndDisplayVisitorInfo(lat,lng),cacheLocationData(lat,lng)},error=>{console.error("Error getting geolocation:",error),fetchAndDisplayVisitorInfo()}):fetchAndDisplayVisitorInfo()}function fetchAndDisplayVisitorInfo(lat,lng){const xhr=new XMLHttpRequest;xhr.open("GET",visitorInfoAPI,!0),xhr.onload=function(){if(200===xhr.status)try{const jsonData=JSON.parse(xhr.responseText);let output="";if(output+=`来自 <b>${jsonData.location||"未知地区"}</b> 啲朋友\n`,output+="食左飯未🍚🥢，你觉得点？😊\n",output+=`你的IP： <b>${jsonData.ip}</b>\n`,!lat||!lng)return void fetch(`${ipLocationAPI}${jsonData.ip}`).then(response=>response.json()).then(ipLocation=>{if(200===ipLocation.code){const lat=ipLocation.data.lat,lng=ipLocation.data.lng,distance=haversineDistance(23.106469,113.32446,lat,lng);output+=`你依家同我差 <b>${distance.toFixed(2)}</b> 公里！\n`}else output+=`无法获取地理信息: ${ipLocation.msg||"未知错误"}\n`;output+=`${jsonData.tq||"未知天气"}${jsonData.low||"?"}-${jsonData.high||"?"}风力${jsonData.fl||"未知风力"}\n`,output+=`${jsonData.tip||"暂无温馨提示"}\n`,displayOutput(output)}).catch(error=>{console.error("Error fetching IP location:",error),displayDefaultMessage()});{const distance=haversineDistance(23.106469,113.32446,lat,lng);output+=`你依家同我差 <b>${distance.toFixed(2)}</b> 公里！\n`}output+=`${jsonData.tq||"未知天气"}${jsonData.low||"?"}-${jsonData.high||"?"}风力${jsonData.fl||"未知风力"}\n`,output+=`${jsonData.tip||"暂无温馨提示"}\n`,displayOutput(output)}catch(error){console.error("Error parsing JSON:",error),displayOutput("解析访客信息失败")}else console.error(`请求访客信息失败: ${xhr.status}`),displayOutput("请求访客信息失败")},xhr.send()}function displayDefaultMessage(){displayOutput("欢迎朋友来访~")}function displayOutput(output){const resultElement=document.getElementById("visitorInfo");resultElement&&(resultElement.innerHTML=output.replace(/\n/g,"<br>"))}function cacheLocationData(lat,lng){const ipInfo={lat:lat,lng:lng,expirationTime:new Date((new Date).getTime()+36e5).toISOString()};localStorage.setItem("ipInfo",JSON.stringify(ipInfo))}function checkGeolocationPermission(){const permissionDialog=document.querySelector(".permission-dialog");permissionDialog.style.display="block",document.querySelector('button[data-action="allow"]').addEventListener("click",()=>{permissionDialog.style.display="none",handleGeolocation()}),document.querySelector('button[data-action="deny"]').addEventListener("click",()=>{permissionDialog.style.display="none",displayDefaultMessage()})}checkGeolocationPermission();const cachedIpInfo=localStorage.getItem("ipInfo");if(cachedIpInfo){const ipInfo=JSON.parse(cachedIpInfo),now=new Date,expirationTime=new Date(ipInfo.expirationTime);if(now<expirationTime)return void fetchAndDisplayVisitorInfo(ipInfo.lat,ipInfo.lng)}}document.addEventListener("DOMContentLoaded",()=>{"/"===window.location.pathname&&initializeCard()}),document.addEventListener("pjax:complete",()=>{"/"===window.location.pathname&&initializeCard()});